{% extends 'base.html' %}

{% block head %}
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flat-ui/2.2.2/css/flat-ui.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <style>
		body {
			  font-family: 'Open Sans', sans-serif;
			  font-weight: 300;
			  line-height: 1.42em;
			  color:#A7A1AE;
			  background-color:#1F2739;
			}
			
			h1 {
			  font-size:3em;
			  font-weight: 300;
			  line-height:1em;
			  text-align: center;
			  color: #4DC3FA;
			}

			h2 {
			  font-size:3em;
			  font-weight: 300;
			  font-weight: bold;
			  line-height:1em;
			  text-align: center;
			  color: white;
			}
			
			.per {
				font-size: 15px;
			}
			
			.container2 th h1 {
				  font-weight: bold;
				  font-size: 1.3em;
			  color: #185875;
			}

			.container2 td {
				  font-weight: normal;
				  font-size: 1em;
			  -webkit-box-shadow: 0 2px 2px -2px #0E1119;
				   -moz-box-shadow: 0 2px 2px -2px #0E1119;
						box-shadow: 0 2px 2px -2px #0E1119;
			}

			.container2 {
				  text-align: center;
				  overflow: hidden;
				  text-overflow: clip;
				  width: 90%;
				  margin: 0 auto;
			  display: table;
			  padding: 0 0 8em 0;
			}

			.container2 .shift {
				width: 10%;
			}

			.container2 td, .container2 th {
				  padding-bottom: 2%;
				  padding-top: 2%;
			  padding-left:2%;
			}

			/* Background-color of the odd rows */
			.container2 tr:nth-child(odd) {
				  background-color: #323C50;
			}

			/* Background-color of the even rows */
			.container2 tr:nth-child(even) {
				  background-color: #2C3446;
			}

			.container2 th {
				  background-color: #1F2739;
			}

			.container2 tr:hover {
			   background-color: #464A52;
				-webkit-box-shadow: 0 6px 6px -6px #0E1119;
				   -moz-box-shadow: 0 6px 6px -6px #0E1119;
						box-shadow: 0 6px 6px -6px #0E1119;
			}

			.container2 td:hover {
			  background-color: #FFF842;
			  color: #403E10;
			  box-shadow: #7F7C21 -1px 1px, #7F7C21 -2px 2px, #7F7C21 -3px 3px, #7F7C21 -4px 4px, #7F7C21 -5px 5px, #7F7C21 -6px 6px;
			  transform: translate3d(6px, -6px, 0);

			  transition-delay: 0s;
				  transition-duration: 0.4s;
				  transition-property: all;
			  transition-timing-function: line;
			}
			
			.transparent {
			  background: transparent;
			}
			
			/* The Modal (background) */
			.modal {
			  display: none; /* Hidden by default */
			  position: fixed; /* Stay in place */
			  z-index: 1; /* Sit on top */
			  padding-top: 100px; /* Location of the box */
			  left: 20%;
			  top: 0;
			  width: 60%; /* Full width */
			  height: 50%; /* Full height */
			  overflow: auto; /* Enable scroll if needed */
			}

			/* Modal Content */
			..modal-content {
			  position: relative;
			  background-color: #fefefe;
			  margin: auto;
			  padding: 0;
			  border: 1px solid #888;
			  width: 80%;
			  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
			  -webkit-animation-name: animatetop;
			  -webkit-animation-duration: 0.4s;
			  animation-name: animatetop;
			  animation-duration: 0.4s;
			}
			
			/* Add Animation */
			@-webkit-keyframes animatetop {
			  from {top:-300px; opacity:0} 
			  to {top:0; opacity:1}
			}

			@keyframes animatetop {
			  from {top:-300px; opacity:0}
			  to {top:0; opacity:1}
			}
			
			/* The Close Button */
			.close_btn {
			  color: white;
			  float: right;
			  font-size: 28px;
			  font-weight: bold;
			}

			.close_btn:hover,
			.close_btn:focus {
			  color: #000;
			  text-decoration: none;
			  cursor: pointer;
			}

			.modal-body {
				padding: 2px 16px;
			}
			
			#menuToggle {
			  display: block;
			  position: fixed;
			  top: 20px;
			  left: 20px;
			  
			  z-index: 1;
			  
			  -webkit-user-select: none;
			  user-select: none;
			}

			#menuToggle a{
			  text-decoration: none;
			  color: #232323;
			  
			  transition: color 0.3s ease;
			}

			#menuToggle a:hover{
			  color: tomato;
			}


			#menuToggle input{
			  display: block;
			  width: 40px;
			  height: 32px;
			  position: absolute;
			  top: -7px;
			  left: -5px;
			  
			  cursor: pointer;
			  
			  opacity: 0; /* hide this */
			  z-index: 2; /* and place it over the hamburger */
			  
			  -webkit-touch-callout: none;
			}

			#menuToggle span{
			  display: block;
			  width: 33px;
			  height: 4px;
			  margin-bottom: 5px;
			  position: relative;
			  
			  background: #cdcdcd;
			  border-radius: 3px;
			  
			  z-index: 1;
			  
			  transform-origin: 4px 0px;
			  
			  transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0),
						  background 0.5s cubic-bezier(0.77,0.2,0.05,1.0),
						  opacity 0.55s ease;
			}

			#menuToggle span:first-child{
			  transform-origin: 0% 0%;
			}

			#menuToggle span:nth-last-child(2){
			  transform-origin: 0% 100%;
			}

			#menuToggle input:checked ~ span{
			  opacity: 1;
			  transform: rotate(45deg) translate(-2px, -1px);
			  background: #232323;
			}

			#menuToggle input:checked ~ span:nth-last-child(3){
			  opacity: 0;
			  transform: rotate(0deg) scale(0.2, 0.2);
			}
			
			#menuToggle input:checked ~ span:nth-last-child(2){
			  transform: rotate(-45deg) translate(0, -1px);
			}
			#menu{
			  position: absolute;
			  width: 300px;
			  margin: -100px 0 0 -50px;
			  padding: 50px;
			  padding-top: 125px;
			  
			  background: #ededed;
			  list-style-type: none;
			  -webkit-font-smoothing: antialiased;
			  /* to stop flickering of text in safari */
			  
			  transform-origin: 0% 0%;
			  transform: translate(-100%, 0);
			  
			  transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0);
			}

			#menu li{
			  padding: 10px 0;
			  font-size: 22px;
			}

			#menuToggle input:checked ~ ul{
			  transform: none;
			}
			
			body.swal2-shown > [aria-hidden="true"] {
			  filter: blur(10px);
			}

			body > * {
			  transition: 0.1s filter linear;
			}
			
			 .fa-print, .fa-cogs, .fa-plus-circle{
				 font-size:36px;
				float:right;
				padding-right:20px;
				cursor: pointer;
			 }
			
			@media (max-width: 800px) {
				.container2 td {font-size: 0.5em;}
				.container2 th h1{font-size: 0.5em;}
				.per {font-size: 0.8em;}
				 h1 { font-size: 2em; }
				.fa-print, .fa-cogs, .fa-plus-circle { font-size: 24px;}
			}
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
	function check_shift(shift, date, id) {
		$.ajax(
			{ url: '/schedule/create_shift/' + shift + '/' + date + "/check",
			 success: function(data){
				if (data['db'] == "None"){
					document.getElementById(id).style.color = "grey";
					document.getElementById(id).innerHTML = "";
				}else{
					document.getElementById(id).style.color = "red";
					document.getElementById(id).innerHTML = "blocked by " + "{{ g.user['username'] }}";
				}
			}
		});
	}
	
    function create(shift, date, id){
		var status = document.getElementById(id).textContent;
		$.ajax({ url: '/schedule/create_shift/' + shift + '/' + date  + "/handle"});
		if (status == "blocked by " + "{{ g.user['username'] }}"){
			document.getElementById(id).style.color = "grey";
			document.getElementById(id).innerHTML = "";
		}else{
			document.getElementById(id).style.color = "red";
			document.getElementById(id).innerHTML = "blocked by " + "{{ g.user['username'] }}";
		}
    }
	
	function add(){
		document.getElementById("add_pop").style.display = "block";
	}
	
	function close_add(){
		document.getElementById("add_pop").style.display = "none";
	}
	
	function alert_fire(){
		(async () => {
			const { value: formValues } = await Swal.fire({
			  title: '<strong style="color: white;">Add Shift:</strong>',
			  background: "linear-gradient(#373B44, #4286f4)",
			  html:
				'<label style="color: white;">Shifts:</label><select id="swal-input1" class="swal2-input" style="color: white;">{% for shift in table %}<option value="{{ shift }}" style="color: black;">{{ shift }}</option>{% endfor %}</select>' + 
				'<label style="color: white;">Days:</label><select id="swal-input2" class="swal2-input"  style="color: white;">{% for i in range_matrix %}{% for j in range2 %}<option value="{{ days[i][j].replace("\r\n", " ") }}" style="color: black;">{{ days[i][j].replace("\r\n", " ") }}</option>{% endfor %}{% endfor %}</select>' +
			  '<label style="color: white;">Username:</label><select id="swal-input3" class="swal2-input" style="color: white;">{% for user in users %}{% if user["username"] != "superuser" %}<option value="{{ user["username"] }}" style="color: black;">{{ user["username"] }}</option>{% endif %}{% endfor %}</select>',
			  focusConfirm: false,
			  preConfirm: () => {
				let formValues = [
				  document.getElementById('swal-input1').value,
				  document.getElementById('swal-input2').value,
				  document.getElementById('swal-input3').value
				]
				
				let res = {
					shift: $(formValues)[0],
					date: $(formValues)[1],
					username: $(formValues)[2]
				  };
				
				return $.post('{{ url_for("admin.schedule_add") }}', {
					shift: $(formValues)[0],
					date: $(formValues)[1],
					username: $(formValues)[2]}, function(){location.reload(true);});
			  }
			})
		})()
	}
	
	
	
	function set_text(id1, id2, msg) { 
		$(id1).text(msg);
		$(id2).text(msg);
	}
	
	function al(action, id){
		if (action == 1){
			alert("edit " + id.toString());
		}
		else{
			alert("delete " + id.toString());
		}
	}
	
	function del_shift(time, day, name){
		$.post('{{ url_for("admin.schedule_del") }}', {
			shift: time,
			date: day,
			username: name}, function(){location.reload(true);});
	}
	
	function delete_at(id1, id2, shift, date, name){
		if (confirm("Are you Sure you want to delete this shift? ")){
			$(".table" + id1).remove(); 
			alert("shift: " + shift + " date: " + date);
			del_shift(shift, date, name);
		}
	}
	
	async function edit_shift(id) {
		// const { value: formValues } = await 
		Swal.fire({
			title: '<strong style="color: white;">Edit Shift:</strong>',
			background: "linear-gradient(#373B44, #4286f4)",
			html:
				'<label style="color: white;">Shifts:</label><select id="swal-input1" class="swal2-input" style="color: white;">{% for shift in table %}<option value="{{ shift }}" style="color: black;">{{ shift }}</option>{% endfor %}</select>' + 
				'<label style="color: white;">Days:</label><select id="swal-input2" class="swal2-input"  style="color: white;">{% for i in range_matrix %}{% for j in range2 %}<option value="{{ days[i][j].replace("\r\n", " ") }}" style="color: black;">{{ days[i][j].replace("\r\n", " ") }}</option>{% endfor %}{% endfor %}</select>' +
				'<label style="color: white;">Username:</label><select id="swal-input3" class="swal2-input" style="color: white;">{% for user in users %}{% if user["username"] != "superuser" %}<option value="{{ user["username"] }}" style="color: black;">{{ user["username"] }}</option>{% endif %}{% endfor %}</select>',
			focusConfirm: false,
			preConfirm: () => {
				let formValues = [
				  document.getElementById('swal-input1').value,
				  document.getElementById('swal-input2').value,
				  document.getElementById('swal-input3').value
				]
				
				let res = {
					shift: $(formValues)[0],
					date: $(formValues)[1],
					username: $(formValues)[2]
				  };
				
				return res;
			}
		}).then((result) => {
			// Swal.fire(`${result.value.shift} - ${result.value.date} - ${result.value.username}`.trim())
			if (result == ["", "", ""]){
				alert("nothing");
			}
			else {
				$.post('{{ url_for("admin.schedule_add") }}', {
					shift: $(formValues)[0],
					date: $(formValues)[1],
					username: $(formValues)[2]}, function(){location.reload(true);});
			}
			// Swal.fire(`${shift} - ${date}`)
		})
		// alert("shift: " + shift + " date: " + date);
	}
	
	function alert_edit_main2(){
		(async () => {
			const { value: formValues } = await Swal.fire({
			  title: '<strong style="color: white;">Edit Main:</strong>',
			  background: "linear-gradient(#373B44, #4286f4)",
			  html:
				'<table style="width:100%;" class="table1"><tr><td><p class="swal2-input" style="color: white; padding-top: 5px;">Blocked by user</p></td><td><i   id="e1" class="fa fa-pencil swal2-input" style="color: white; padding-top: 10px;" onclick="edit_shift(1,2,3,4)"></i></td><td><i id="t1" class="fa fa-trash swal2-input" style="color: white; padding-top: 10px;" onclick="delete_at(1, 1, &quot;{{ table[0] }}&quot;, &quot;{{ days[0][0].replace("\r\n", " ") }}&quot;)"></i></td></tr></table>' +
				'<table style="width:100%;"  class="table2"><tr><td><p class="swal2-input" style="color: white; padding-top: 5px;">Blocked by admin</p></td><td><i  id="e2" class="fa fa-pencil swal2-input" style="color: white; padding-top: 10px;" onclick="al(1, 2)"></i></td><td><i id="t2" class="fa fa-trash swal2-input" style="color: white; padding-top: 10px;" onclick="al(0, 2)"></i></td></tr></table>',
			  focusConfirm: false
			})
		})()
	}
	
	/*'<input class="swal2-input" type="text" name="subject" placeholder="Subject">' + '<input class="swal2-input" type="text" name="subject" placeholder="Subject">' +*/
	function sidemenu(){
		Swal.fire({
		  title: '<h3 style="text-decoration: underline;">Table Settings:</h3>',
		  html: '<form method="post" action="{{ url_for("admin.schedule") }}">' +
				'<label style="color: black;"> Start Date:</label><input class="swal2-input" type="date" name="date" style="color: black;">' +
				'<input class="swal2-input" type="submit" value="Send" style="background: #0575E6; color: white;"></form>',
		  position: 'top-end',
		  showClass: {
			popup: `
			  animate__animated
			  animate__fadeInRight
			  animate__faster
			`
		  },
		  hideClass: {
			popup: `
			  animate__animated
			  animate__fadeOutRight
			  animate__faster
			`
		  },
		  grow: 'column',
		  width: 300,
		  showConfirmButton: false,
		  showCloseButton: true
		})
	}
	
	async function add_alert(time, day){
		Swal.fire({
			title: '<strong style="color: white;">Add Shift:</strong>',
			background: "linear-gradient(#373B44, #4286f4)",
			html:
				'<label style="color: white;">Username:</label><select id="swal-input1" class="swal2-input" style="color: white;">{% for user in users %}{% if user["username"] != "superuser" %}<option value="{{ user["username"] }}" style="color: black;">{{ user["username"] }}</option>{% endif %}{% endfor %}</select>',
			focusConfirm: false,
			preConfirm: () => {
				let res = { username: document.getElementById('swal-input1').value };
				
				return res;
			}
		}).then((result) => {
			alert(time + " - " + day  + " - " + result.value.username)
			return $.post('{{ url_for("admin.schedule_add") }}', {
				shift: time,
				date: day,
				username: result.value.username}, function(){location.reload(true);});
		})
	}
	
	async function create_table(){
		Swal.fire({
			title: '<strong style="color: white;">Create Table:</strong>',
			background: "linear-gradient(#373B44, #4286f4)",
			html: '<label style="color: white;">Table Number:</label><select id="swal-input1" class="swal2-input" style="color: white;">{% for i in range_matrix %}<option value="{{ i+1 }}" style="color: black;">{{ i+1 }}</option>{% endfor %}</select>',
			focusConfirm: false,
			preConfirm: () => {
				return res = document.getElementById('swal-input1').value;
			}
		}).then((result) => {
			return $.post('{{ url_for("admin.construct_table") }}', {
				date: '{{ currrent_date }}',
				number: result.value}, function(){window.open("{{ url_for('admin.construct_table') }}", '_blank');});
		})
	}
	
  </script>
  
{% endblock %}
{% block header %}	
	<nav role="navigation">
	  <div id="menuToggle">
		<input type="checkbox" />
		<span></span>
		<span></span>
		<span></span>
		<ul id="menu">
		  <a href="{{ url_for('home.index') }}"><li><i class="fa fa-home" aria-hidden="true" style="font-size:24px;"></i>  Home</li></a>
		  <a href="{{ url_for('admin.index') }}"><li><i class="fa fa-user-secret" aria-hidden="true" style="font-size:24px;"></i>  Admin Page</li></a>
		  <a href="{{ url_for('admin.users') }}"><li><i class="fa fa-users" style="font-size:24px;"></i>  Users</li></a>
		  <a href="{{ url_for('admin.settings') }}"><li><i class="fa fa-cog" aria-hidden="true" style="font-size:24px;"></i>  Settings</li></a>
		  {% if g.user['rank'] == 0 %}
			<a href="{{ url_for('admin.log') }}"><li><i class="fa fa-file-text-o" aria-hidden="true" style="font-size:24px;"></i>  Log File</li></a>
		  {% endif %}
		  <a href="{{ url_for('auth.logout') }}"><li><i class="fa fa-sign-out" aria-hidden="true" style="font-size:24px;"></i>  Logout</li></a>
		</ul>
	  </div>
	</nav>

  <h1 style="text-align: center;"><i class="icon fa fa-list-alt" onclick="alert_edit_main2()"></i>   {% block title %}Schedule{% endblock %}
  <i class="fa fa-cogs" aria-hidden="true" onclick="sidemenu()"></i>
  <i id="plus" class="fa fa-plus-circle" aria-hidden="true" onclick="alert_fire()"></i>
  <i id="print" class="fa fa-print" onclick="create_table()"></i>
  <!-- <a href="{{ url_for('admin.construct_table') }}" target="_blank"><i id="print" class="fa fa-print" onclick="create_table()"></i></a></h1> -->
 
{% endblock %}

{% block content %}
	{% for index in range_matrix %}
	  <table class="container2">
		<tr>
		  <th><h1>______</h1></th>
		  {% for k in range2 %}
			<th><h1>{{ days[index][k] }}</h1></th>
		  {% endfor %}
		</tr>
		{% for i in range %}
		<tr>
		  <td class="shift" style="text-align: center;">{{ table[i].replace(":00", "") }}</td>
		  {% for j in range2 %}
			<script>
			async function alert_edit_main{{ index }}{{ i }}{{ j }}(){
				const { value: formValues } = await Swal.fire({
					title: '<strong style="color: white;">Edit Main:</strong>',
					background: "linear-gradient(#373B44, #4286f4)",
					html:
						'{% for row in schedule %}{% if (table[i] == row["shift"]) and (days[index][j].replace("\r\n", " ") == row["date"]) %}<table style="width:100%;" class="table{{ row["id"] }}"><tr><td><p class="swal2-input" style="color: white; padding-top: 5px;">blocked by {{ row["username"] }}</p></td><td><i id="e1" class="fa fa-pencil swal2-input" style="color: white; padding-top: 10px;" onclick="edit_shift(&quot;p{{ i }}{{ j }}&quot;)"></i></td><td><i id="t1" class="fa fa-trash swal2-input" style="color: white; padding-top: 10px;" onclick="delete_at({{ row["id"] }}, &quot;p{{ i }}{{ j }}&quot;, &quot;{{ table[i] }}&quot;, &quot;{{ days[index][j].replace("\r\n", " ") }}&quot;, &quot;{{ row["username"] }}&quot;)"></i></td></tr></table>{% endif %} {% endfor %}' + 
						'<table style="width:100%;"><tr><td class="swal2-input" style="color: white;">add a shift: </td><td class="swal2-input"><i class="fa fa-plus" style="font-size:15px; padding-top: 5px; cursor: pointer; color:white;" onclick="add_alert(&quot;{{ table[i] }}&quot;, &quot;{{ days[index][j].replace("\r\n", " ") }}&quot;)"></i></td></tr></table>',
					focusConfirm: false
				})
			}
			</script>
			<td class="square{{ index }}{{ i }}{{ j }}" style="text-align: center;" onclick="alert_edit_main{{ index }}{{ i }}{{ j }}()">
			  {% for row in schedule %}
				  {% if (table[i] == row["shift"]) and (days[index][j].replace("\r\n", " ") == row["date"]) %}
					{% if g.user['id'] == row['author_id'] %}
						<p id="p{{ index }}{{ i }}{{ j }}" class="per" style="color: red;">blocked by {{ row['username'] }}</p>
					{% else %}
						<p class="per" style="color: red;">blocked by {{ row['username'] }}</p>
					{% endif %}
				  {% endif %}
			  {% endfor %}
			  <p id="p{{ index }}{{ i }}{{ j }}" class="per"></p>			
			</td>
		  {% endfor %}
		</tr>
		{% endfor %}
	  </table>
  {% endfor %}
<br>
<br>
<br>
	<div id="add_pop"  class="modal">
	  <div class="modal-content" style="background-image: linear-gradient(#373B44, #4286f4);">
		<div class="modal-body">
			<span class="close_btn" onclick="close_add()">&times;</span>
			<h2>Add Shift:</h2>
			<form action="{{ url_for('admin.schedule_add') }}" method="post" style="color: black">
				<table style="width: 100%; margin: 0 auto;">
					<tr>
						<th>Shift: </th>
						<th>Date: </th>
						<th>Username: </th>
						<th></th>
					</tr>
					<tr>
						<td>
							<select name="shift" id="shifts" style="border-radius: 8px;">
							{% for shift in table %}
								<option value="{{ shift }}" style="color: black">{{ shift }}</option>
							{% endfor %}
							</select>
						</td>
						<td>
							<select name="date" id="dates" style="border-radius: 8px;">
							{% for i in range_matrix %}
								{% for j in range2 %}
									<option value="{{ date }}" style="color: black">{{ date }}</option>
								{% endfor %}
							{% endfor %}
							</select>
						</td>
						<td>
							<select name="username" id="usernames" style="border-radius: 8px;">
							{% for user in users %}
								{% if user['username'] != "superuser" %}
									<option value="{{ user['username'] }}" style="color: black">{{ user['username'] }}</option>
								{% endif %}
							{% endfor %}
							</select>
						</td>
						<td>
							<input type="submit" value="Add Shift" style="border-radius: 8px;">
						</td>
					</tr>
				</table>
			</form>
		</div>
	  </div>
	</div>
{% endblock %}
